<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>File Upload Test</title>
    <style>
        #dropbox {
            width: 300px;
            height: 200px;
            border: 2px dashed #ccc;
            text-align: center;
            padding: 10px;
            margin: 20px auto;
        }

        #dropbox.highlight {
            background-color: #e8f9ff;
        }

        .success {
            border: 2px solid green !important;
            border-radius: 6px;
            height: 8px;
            position: relative;
            top: -2px;
        }
    </style>

</head>

<body>
    <h1>File Upload Test</h1>

    <div id="dropbox">
        <p>Drag and drop files here</p>
    </div>

    <script>
        var dropbox;

        function handleFileUpload(file) {
            // if filesize is more than 32MB (32 * 1024 * 1024), display an error message
            var progressBar = document.createElement("progress");
            progressBar.id = file.name + "-progress";
            progressBar.value = 0;
            progressBar.max = 100;
            dropbox.appendChild(progressBar);
            var fileName = document.createElement("p");
            fileName.innerHTML = shortenFileName(file.name);
            dropbox.appendChild(fileName);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/new-idea/upload/" + file.name, true);

            xhr.upload.onprogress = function (e) {
                var percentCompleted = Math.round((e.loaded / e.total) * 100);
                progressBar.value = percentCompleted;
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.message === "File uploaded successfully") {
                        progressBar.classList.add("success");
                        // update the progress bar to 100%
                        progressBar.value = 100;
                        var thumbnailURL = response.thumbnailURL;
                        // Display the thumbnailURL in the UI
                    } else {
                        var errorMessage = response.message;
                        // Display the error message in the UI
                        alert(errorMessage);
                    }
                }
            };

            xhr.onerror = function () {
                alert("Error! Upload failed. Can not connect to server.");
            };

            xhr.send(file);
        }

        // function to rewrite long file names as max 8+extension
        function shortenFileName(fileName) {
            var extension = fileName.split('.').pop();
            var fileName = fileName.split('.').slice(0, -1).join('.');
            if (fileName.length > 8) {
                fileName = fileName.substring(0, 8) + '...';
            }
            return fileName + '.' + extension;
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            var files = event.dataTransfer.files;
            // check that no file is more than 32MB if so return an error message
            var oversied = false;
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                if (file.size > 32 * 1024 * 1024) {
                    oversied = true;
                    break;
                }
            }
            if (oversied) {
                alert("Please upload files that are less than 32MB.");
                dropbox.classList.remove("highlight");
                return;
            }
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                handleFileUpload(file);
            }
            dropbox.classList.remove("highlight");
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            dropbox.classList.add("highlight");
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            dropbox.classList.remove("highlight");
        }

        document.addEventListener("DOMContentLoaded", function () {
            dropbox = document.getElementById("dropbox");
            dropbox.addEventListener("dragover", handleDragOver);
            dropbox.addEventListener("dragleave", handleDragLeave);
            dropbox.addEventListener("drop", handleDrop);
        });
    </script>
</body>

</html>